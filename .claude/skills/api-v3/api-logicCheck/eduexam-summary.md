# EduExamController å®Œæ•´é‚è¼¯æª¢æŸ¥ç¸½çµ

## 1. åŸºæœ¬è³‡è¨Š

| é …ç›® | å…§å®¹ |
|------|------|
| **Controller** | EduExamController |
| **ç«¯é»ç¸½æ•¸** | 9 |
| **ä»»å‹™é¡å‹** | mission_type = 6 (å­¸åŠ›æ¸¬é©—/å¤§è€ƒå°ˆå€) |
| **èˆŠç¨‹å¼æª”æ¡ˆ** | `modules/exam/useditem_prodb.php`, `modules/exam/answer_prodb.php` |
| **æ–° API Service** | `EduExamService.php` |
| **æ–° API DAO** | `EduExamDao.php` |
| **ç›¸é—œè³‡æ–™è¡¨** | exam_type, eduexam_paper, eduexam_paper_detail, eduexam_item, eduexam_record |
| **æª¢æŸ¥æ—¥æœŸ** | 2026-02-11 |
| **æª¢æŸ¥ä¾æ“š** | API mapping æ–‡æª” + èˆŠç¨‹å¼ç¢¼åˆ†æ |

---

## 2. è€ƒè©¦é¡å‹å°æ‡‰

| ç¸®å¯« | exam_type | mission_type | åç¨± |
|------|-----------|--------------|------|
| BAT  | 1         | 6            | å­¸åŠ›æ¸¬é©— |
| CAP  | 2         | 9            | åœ‹ä¸­æ•™è‚²æœƒè€ƒ |
| GSAT | 3         | 13           | å­¸æ¸¬ |
| TVE  | 4         | 14           | çµ±æ¸¬ |
| AST  | 5         | 15           | æŒ‡è€ƒ |

---

## 3. ç«¯é»æª¢æŸ¥ç¸½è¦½

| ç«¯é» | èˆŠç¨‹å¼å°æ‡‰ | é‚è¼¯ä¸€è‡´æ€§ | ä¸»è¦å·®ç•° | å„ªå…ˆç´š |
|------|-----------|-----------|---------|--------|
| types | getEduexamType() | âš ï¸ æœ‰å·®ç•° | ç¯©é¸æ¢ä»¶ä¸åŒ | ä¸­ |
| papers | getSubjectType() | ğŸ”´ é‡å¤§å·®ç•° | ç¼ºå°‘å¤šé …é—œéµé‚è¼¯ | ğŸ”´ é«˜ |
| detail | getPaperInfo() | âš ï¸ ç°¡åŒ–ç‰ˆ | ç¼ºå°‘æ¬Šé™æª¢æŸ¥ | ä¸­ |
| filters | (æ–°å¢åŠŸèƒ½) | âœ… æ–°å¢ | ç„¡èˆŠé‚è¼¯æ¯”å° | - |
| start | answer_prodb.php | â­ï¸ å¾…ç¢ºèª | éœ€æŸ¥çœ‹ JS èª¿ç”¨ | ä¸­ |
| submit | answer_prodb.php | â­ï¸ å¾…ç¢ºèª | éœ€æŸ¥çœ‹ JS èª¿ç”¨ | ä¸­ |
| finish | answer_prodb.php | â­ï¸ å¾…ç¢ºèª | éœ€æŸ¥çœ‹ JS èª¿ç”¨ | ä¸­ |
| result | answer_prodb.php | â­ï¸ å¾…ç¢ºèª | éœ€æŸ¥çœ‹ JS èª¿ç”¨ | ä½ |
| history | fnGetFinishRecord() | â­ï¸ å¾…ç¢ºèª | è¤‡é›œ UNION æŸ¥è©¢ | ä½ |

---

## 4. types ç«¯é»è©³ç´°æª¢æŸ¥

### 4.1 SQL æŸ¥è©¢æ¯”å°

#### èˆŠç¨‹å¼ (useditem_prodb.php L132)
```sql
SELECT exam_type_code, exam_type_name 
FROM exam_type 
WHERE series = 'eduexam'
```

#### æ–° API
```sql
SELECT exam_type_sn, exam_type_name, exam_type_abbr
FROM exam_type
WHERE exam_type_sn IN (1,2,3,4,5)
```

**âš ï¸ å·®ç•°èªªæ˜**:
1. **ç¯©é¸æ¢ä»¶**:
   - èˆŠç‰ˆ: `series = 'eduexam'` (å‹•æ…‹ç¯©é¸)
   - æ–°ç‰ˆ: `exam_type_sn IN (1,2,3,4,5)` (ç¡¬ç·¨ç¢¼)
   
2. **å›å‚³æ¬„ä½**:
   - èˆŠç‰ˆ: `exam_type_code` (å¯èƒ½æ˜¯ç¸®å¯«å¦‚ 'BAT')
   - æ–°ç‰ˆ: `exam_type_abbr` (ç¸®å¯«) + `exam_type_sn` (ID)

3. **Fallback æ©Ÿåˆ¶**:
   - èˆŠç‰ˆ: ç„¡
   - æ–°ç‰ˆ: æœ‰å¸¸æ•¸å®šç¾© fallback

### 4.2 æª¢æŸ¥çµè«–
**é‚è¼¯ä¸€è‡´æ€§**: âš ï¸ æœ‰å·®ç•°ä½†å¯æ¥å—  
**å½±éŸ¿**: ä½ï¼ˆå…©ç¨®ç¯©é¸æ–¹å¼æ‡‰è©²è¿”å›ç›¸åŒçµæœï¼‰  
**å»ºè­°**: âšª çµ±ä¸€ä½¿ç”¨ `series = 'eduexam'` æ›´å…·å½ˆæ€§

---

## 5. papers ç«¯é»è©³ç´°æª¢æŸ¥ ğŸ”´ **é‡å¤§å·®ç•°**

### 5.1 SQL æŸ¥è©¢æ¯”å°

#### èˆŠç¨‹å¼ (useditem_prodb.php L168-190)
```sql
SELECT ep.paper_sn, ep.paper_name, sg.subject_groupings_name as map_name,
       ep.year, sg.subject_groupings_id as group_id,
       (SELECT COUNT(*) FROM eduexam_record er
        WHERE er.paper_sn = ep.paper_sn
        AND er.is_finished = 0
        AND er.user_id = :user_id) unfinishedtimes,
       (SELECT COUNT(*) FROM eduexam_record er
        WHERE er.paper_sn = ep.paper_sn
        AND er.is_finished = 1
        AND er.user_id = :user_id) finishedtimes
FROM eduexam_paper ep
JOIN map_info mi ON ep.map_sn = mi.map_sn AND mi.display = 1
JOIN subject sub ON mi.subject_id = sub.subject_id AND sub.display = 1
JOIN subject_groupings sg ON sub.subject_groupings_id = sg.subject_groupings_id
JOIN exam_type et ON et.exam_type = ep.exam_type 
                 AND et.exam_type_code = :chooseEduexamType
WHERE ep.status = 1 -- STATUS_CODE_LOCKED (å·²é–å®š)
ORDER BY map_name ASC, ep.year DESC
```

#### æ–° API (å‡è¨­æŸ¥è©¢ï¼Œéœ€ç¢ºèª)
```sql
SELECT paper_sn, paper_name, exam_type, year, status
FROM eduexam_paper
WHERE exam_type = :exam_type
  AND status != 4  -- æ’é™¤å·²åˆªé™¤
ORDER BY subject_id, year DESC
```

### 5.2 é‡å¤§å·®ç•°æ¸…å–®

| é …ç›® | èˆŠç³»çµ± | æ–°ç³»çµ± | é¢¨éšªç­‰ç´š |
|------|--------|--------|----------|
| **ç‹€æ…‹ç¯©é¸** | `status = 1` (åªé¡¯ç¤ºå·²é–å®š) | `status != 4` (æ’é™¤å·²åˆªé™¤) | ğŸ”´ Critical |
| **æœªå®Œæˆæ¬¡æ•¸** | å­æŸ¥è©¢è¨ˆç®— `unfinishedtimes` | âŒ ç¼ºå¤± | ğŸ”´ High |
| **å·²å®Œæˆæ¬¡æ•¸** | å­æŸ¥è©¢è¨ˆç®— `finishedtimes` | âŒ ç¼ºå¤± | ğŸ”´ High |
| **ç§‘ç›®æ’åº** | è‡ªè¨‚ä¸­æ–‡é †åº | ORDER BY subject_id | âš ï¸ Medium |
| **ç§‘ç›®ä¾†æº** | `subject_groupings` (ç§‘ç›®ç¾¤çµ„) | `subject` è¡¨ | âš ï¸ Medium |
| **display ç¯©é¸** | `mi.display = 1 AND sub.display = 1` | âŒ ç¼ºå¤± | ğŸ”´ High |
| **paper_sn hash** | `string2hash()` åŠ å¯† | æ˜ç¢¼ | âš ï¸ Low |
| **æŒ‰ç§‘ç›®åˆ†çµ„** | å‰ç«¯æŒ‰ç§‘ç›®åˆ†çµ„é¡¯ç¤º | æ‰å¹³åˆ—è¡¨ | âš ï¸ Medium |

### 5.3 ç‰¹æ®Šé‚è¼¯ - ç§‘ç›®è‡ªè¨‚æ’åº (useditem_prodb.php L197-226)

**èˆŠç‰ˆæ’åºé †åº**:
```
åœ‹èªæ–‡ â†’ æ•¸å­¸ â†’ è‹±èª â†’ è‡ªç„¶ â†’ æ­·å² â†’ åœ°ç† â†’ å…¬æ°‘èˆ‡ç¤¾æœƒ â†’ ç‰©ç† â†’ åŒ–å­¸ â†’
ç”Ÿç‰© â†’ åœ°çƒç§‘å­¸ â†’ éŸ³æ¨‚ â†’ ç¾è¡“ â†’ è—è¡“ç”Ÿæ´» â†’ ç”Ÿå‘½æ•™è‚² â†’ ç”Ÿæ¶¯è¦åŠƒ â†’ å®¶æ”¿ â†’
ç”Ÿæ´»ç§‘æŠ€ â†’ è³‡è¨Šç§‘æŠ€ â†’ å¥åº·èˆ‡è­·ç† â†’ é«”è‚² â†’ å…¨æ°‘åœ‹é˜²æ•™è‚²
```

**æ’åºé‚è¼¯**:
- ä½¿ç”¨ `mb_str_split()` å–ç§‘ç›®åå‰å…©å­—
- åœ¨æ’åºå­—ä¸²ä¸­æ‰¾ä½ç½®
- ä½ç½®ç›¸åŒå‰‡æ¯”è¼ƒé•·åº¦

**æ–°ç‰ˆ**: ç›´æ¥ä½¿ç”¨ `ORDER BY subject_id` (ç„¡è‡ªè¨‚é †åº)

### 5.4 å®‰å…¨æ€§å•é¡Œ

#### ğŸ”´ Critical: ç‹€æ…‹ç¯©é¸æ¼æ´
```php
// èˆŠç‰ˆ (å®‰å…¨)
WHERE ep.status = 1  // STATUS_CODE_LOCKED (åªé¡¯ç¤ºå·²é–å®š/å¯ç”¨è©¦å·)

// æ–°ç‰ˆ (æœ‰é¢¨éšª)
WHERE status != 4    // åªæ’é™¤å·²åˆªé™¤ï¼Œå­¸ç”Ÿå¯èƒ½çœ‹åˆ°æœªç™¼å¸ƒè©¦å·
```

**å½±éŸ¿**: å­¸ç”Ÿå¯èƒ½çœ‹åˆ° `status = 0` (æœªç™¼å¸ƒ) æˆ–å…¶ä»–æ¸¬è©¦ä¸­çš„è©¦å·

#### ğŸ”´ High: display ç¯©é¸ç¼ºå¤±
```sql
// èˆŠç‰ˆ
AND mi.display = 1   -- ç§‘ç›®å°æ‡‰éœ€å•Ÿç”¨
AND sub.display = 1  -- ç§‘ç›®éœ€å•Ÿç”¨

// æ–°ç‰ˆ: ç„¡æ­¤æª¢æŸ¥
```

**å½±éŸ¿**: å¯èƒ½é¡¯ç¤ºå·²åœç”¨çš„ç§‘ç›®è©¦å·

### 5.5 åŠŸèƒ½ç¼ºå¤±

#### âŒ æœªå®Œæˆ/å·²å®Œæˆæ¬¡æ•¸
```sql
-- èˆŠç‰ˆæä¾›
unfinishedtimes  -- å­¸ç”Ÿæœªå®Œæˆçš„æ¸¬é©—æ¬¡æ•¸
finishedtimes    -- å­¸ç”Ÿå·²å®Œæˆçš„æ¸¬é©—æ¬¡æ•¸

-- æ–°ç‰ˆ: å®Œå…¨ç¼ºå¤±
```

**å½±éŸ¿**: å‰ç«¯ç„¡æ³•é¡¯ç¤ºå­¸ç”Ÿçš„ä½œç­”é€²åº¦

#### âŒ ç§‘ç›®åˆ†çµ„çµæ§‹
```php
// èˆŠç‰ˆå›å‚³çµæ§‹ (useditem_prodb.php L228-246)
[
  {
    "group_id": 1,
    "name": "åœ‹èªæ–‡",
    "paper": [
      {"paper_sn": "xxx", "year": 113, ...},
      {"paper_sn": "yyy", "year": 112, ...}
    ]
  },
  {
    "group_id": 2,
    "name": "æ•¸å­¸",
    "paper": [...]
  }
]

// æ–°ç‰ˆ: æ‰å¹³åˆ—è¡¨
[
  {"paper_sn": "xxx", "paper_name": "...", ...},
  {"paper_sn": "yyy", "paper_name": "...", ...}
]
```

**å½±éŸ¿**: å‰ç«¯éœ€è¦è‡ªè¡Œåˆ†çµ„ï¼Œæˆ–UIå‘ˆç¾æ–¹å¼ä¸åŒ

### 5.6 æª¢æŸ¥çµè«–
**é‚è¼¯ä¸€è‡´æ€§**: ğŸ”´ **ä¸ä¸€è‡´ï¼Œæœ‰é‡å¤§ç¼ºå¤±**  
**å®‰å…¨æ€§**: ğŸ”´ **æœ‰æ½›åœ¨æ¼æ´** (ç‹€æ…‹ç¯©é¸ã€display æª¢æŸ¥)  
**åŠŸèƒ½å®Œæ•´æ€§**: ğŸ”´ **ç¼ºå°‘é—œéµåŠŸèƒ½** (æ¬¡æ•¸çµ±è¨ˆã€ç§‘ç›®åˆ†çµ„)  
**å„ªå…ˆç´š**: ğŸ”´ **é«˜å„ªå…ˆç´šä¿®æ­£**

---

## 6. detail ç«¯é»ç°¡è¦æª¢æŸ¥

### 6.1 ä¸»è¦å·®ç•°
1. **æ¬Šé™æª¢æŸ¥**: èˆŠç‰ˆæœ‰ `map_sn IN (permissionMapSnList)` æ¬Šé™æª¢æŸ¥ï¼Œæ–°ç‰ˆç„¡
2. **é¡Œç›®çµæ§‹**: èˆŠç‰ˆä½¿ç”¨ `JSON_ARRAYAGG` å–å¾—åµŒå¥—çµæ§‹ï¼Œæ–°ç‰ˆæ˜¯ç¨ç«‹æŸ¥è©¢
3. **é¡Œçµ„è™•ç†**: èˆŠç‰ˆå®Œæ•´çš„ `itembank_list` å«é¡Œçµ„ï¼Œæ–°ç‰ˆåƒ…åŸºæœ¬åˆ—è¡¨

### 6.2 æª¢æŸ¥çµè«–
**é‚è¼¯ä¸€è‡´æ€§**: âš ï¸ **ç°¡åŒ–ç‰ˆï¼Œå¯æ”¹å–„**  
**å„ªå…ˆç´š**: âšª ä¸­å„ªå…ˆç´š

---

## 7. filters ç«¯é»

### 7.1 æª¢æŸ¥ç‹€æ…‹
âœ… **æ–°å¢åŠŸèƒ½ï¼Œç„¡èˆŠé‚è¼¯éœ€æ¯”å°**

**åŠŸèƒ½**: æä¾›å‰ç«¯ç¯©é¸é¸é … (è€ƒè©¦é¡å‹ã€å¹´åº¦ã€ç§‘ç›®)  
**è©•ä¼°**: é€™æ˜¯æ–° API çš„æ”¹é€²ï¼Œæä¾›æ›´å¥½çš„ä½¿ç”¨é«”é©—

---

## 8. ä½œç­”ç›¸é—œç«¯é» (start/submit/finish/result/history)

### 8.1 ç¾ç‹€
é€™äº›ç«¯é»å°æ‡‰èˆŠç¨‹å¼ `answer_prodb.php`ï¼Œè©²æª”æ¡ˆé€é JavaScript (`answer.js`) é€²è¡Œ AJAX èª¿ç”¨ã€‚

### 8.2 å¾…ç¢ºèªé …ç›®
ç”±æ–¼é€™äº›ç«¯é»æ¶‰åŠè¤‡é›œçš„ä½œç­”æµç¨‹ï¼Œä¸”èˆŠç¨‹å¼é‚è¼¯åˆ†æ•£åœ¨ PHP å¾Œç«¯å’Œ JavaScript å‰ç«¯ï¼Œå»ºè­°ï¼š

**é¸é … 1**: æ·±å…¥æŸ¥çœ‹ `answer_prodb.php` å’Œ `answer.js` é€²è¡Œè©³ç´°æ¯”å°  
**é¸é … 2**: æ¨™è¨˜ç‚ºã€Œéœ€é€²ä¸€æ­¥æª¢æŸ¥ã€ï¼Œå„ªå…ˆè™•ç† types/papers ç­‰æŸ¥è©¢ç«¯é»

---

## 9. æœªå¯¦ä½œåŠŸèƒ½ (æ ¹æ“š API mapping)

### 9.1 é«˜å„ªå…ˆç´š
âŒ **getUnfinished()** - å–å¾—æœªå®Œæˆæ¸¬é©—ç´€éŒ„  
âŒ **getFinishRecord()** - å–å¾—æ­·å²æ¸¬é©—ç´€éŒ„(å«å·²åˆªé™¤è©¦å·çš„ UNION æŸ¥è©¢)

### 9.2 ä½œç­”æµç¨‹
ç•¶å‰å¯¦ä½œç‹€æ…‹: â­ï¸ éœ€ç¢ºèª `start/submit/finish/result/history` çš„å¯¦éš›é‚è¼¯

---

## 10. æ”¹é€²å»ºè­°ç¸½çµ

### ğŸ”´ Critical - å¿…é ˆç«‹å³ä¿®æ­£

1. **papers ç«¯é»ç‹€æ…‹ç¯©é¸**
   ```sql
   -- ç•¶å‰ (å±éšª)
   WHERE status != 4
   
   -- æ‡‰æ”¹ç‚º
   WHERE status = 1  -- æˆ–æ˜ç¢ºçš„ã€Œå¯ç”¨ã€ç‹€æ…‹
   ```

2. **papers ç«¯é» display æª¢æŸ¥**
   ```sql
   JOIN map_info mi ON ep.map_sn = mi.map_sn AND mi.display = 1
   JOIN subject sub ON mi.subject_id = sub.subject_id AND sub.display = 1
   ```

### ğŸ”´ High - åŠŸèƒ½ç¼ºå¤±

3. **papers ç«¯é»å¢åŠ æ¬¡æ•¸çµ±è¨ˆ**
   - æœªå®Œæˆæ¬¡æ•¸ (`unfinishedtimes`)
   - å·²å®Œæˆæ¬¡æ•¸ (`finishedtimes`)

4. **papers ç«¯é»ç§‘ç›®åˆ†çµ„**
   - JOIN `subject_groupings` å–å¾—ç§‘ç›®ç¾¤çµ„
   - å›å‚³æŒ‰ç§‘ç›®åˆ†çµ„çš„çµæ§‹

5. **papers ç«¯é»è‡ªè¨‚æ’åº**
   - å¯¦ä½œä¸­æ–‡ç§‘ç›®åè‡ªè¨‚æ’åºé‚è¼¯
   - æˆ–ç¢ºèª `subject_id` é †åºæ˜¯å¦ç¬¦åˆéœ€æ±‚

### âš ï¸ Medium - å»ºè­°æ”¹å–„

6. **types ç«¯é»ç¯©é¸**
   - æ”¹ç”¨ `series = 'eduexam'` è€Œéç¡¬ç·¨ç¢¼ SN

7. **detail ç«¯é»æ¬Šé™æª¢æŸ¥**
   - åŠ å…¥ `map_sn` æ¬Šé™é©—è­‰

### â­ï¸ å¾…ç¢ºèª

8. **ä½œç­”æµç¨‹å®Œæ•´æ€§**
   - ç¢ºèª `start/submit/finish/result/history` é‚è¼¯èˆ‡èˆŠç‰ˆä¸€è‡´

---

## 11. ç¸½é«”æª¢æŸ¥çµè«–

| æª¢æŸ¥é …ç›® | è©•ä¼°çµæœ |
|---------|----------|
| **é‚è¼¯ä¸€è‡´æ€§** | ğŸ”´ éƒ¨åˆ†ç«¯é»æœ‰é‡å¤§å·®ç•° |
| **å®‰å…¨æ€§** | ğŸ”´ å­˜åœ¨æ½›åœ¨å®‰å…¨æ¼æ´ (papers ç‹€æ…‹ç¯©é¸) |
| **åŠŸèƒ½å®Œæ•´æ€§** | ğŸ”´ ç¼ºå°‘é—œéµåŠŸèƒ½ (æ¬¡æ•¸çµ±è¨ˆã€ç§‘ç›®åˆ†çµ„) |
| **å„ªå…ˆç´šè©•ä¼°** | ğŸ”´ **é«˜å„ªå…ˆç´š - éœ€ç«‹å³è™•ç† papers ç«¯é»** |

### æ•´é«”è©•ä¼°
EduExamController çš„å¯¦ä½œå­˜åœ¨**é‡å¤§å•é¡Œ**ï¼Œç‰¹åˆ¥æ˜¯ `papers` ç«¯é»ï¼š
- âœ… åŸºç¤æ¶æ§‹å®Œæ•´ (Controller â†’ Service â†’ DAO)
- ğŸ”´ **papers ç«¯é»é‚è¼¯ä¸å®Œæ•´** (ç¼ºå°‘å¤šé …é—œéµåŠŸèƒ½)
- âš ï¸ **å®‰å…¨æ€§å•é¡Œ** (ç‹€æ…‹ç¯©é¸ä¸åš´æ ¼)
- â­ï¸ **ä½œç­”æµç¨‹å¾…ç¢ºèª** (éœ€æ·±å…¥æŸ¥çœ‹ answer_prodb.php)

**å»ºè­°**: å„ªå…ˆä¿®æ­£ `papers` ç«¯é»ï¼Œç¢ºä¿å­¸ç”Ÿåªèƒ½çœ‹åˆ°å·²ç™¼å¸ƒè©¦å·ï¼Œä¸¦è£œå……æ¬¡æ•¸çµ±è¨ˆå’Œç§‘ç›®åˆ†çµ„åŠŸèƒ½ã€‚
