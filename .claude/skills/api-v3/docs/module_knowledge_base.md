# API-V3 模組功能知識庫

**用途**：API 設計參考文件，描述各模組功能含意與資料庫設計
**最後更新**：2026-02-05

---

## 一、後端架構概述

### 核心設計目標
- **統一入口**：所有請求經由 `index.php` 處理
- **分層架構**：Controller → Service → DAO，職責明確分離
- **標準化回應**：統一 JSON 格式與錯誤處理

### 分層職責

| 層級 | 職責 | 禁止 |
|------|------|------|
| **Controller** | 接收參數、權限驗證、呼叫 Service | 業務邏輯、直接操作資料庫 |
| **Service** | 商業邏輯、業務驗證、流程控制 | 處理 HTTP 請求、直接寫 SQL |
| **DAO** | 資料庫 CRUD、SQL 查詢 | 業務邏輯、異常處理 |
| **Helper** | 工具函式、資料轉換 | 業務邏輯、操作資料庫 |

---

## 二、模組功能說明

### 2.1 任務模組 (Mission)

**功能定位**：學生任務管理核心模組

**主要功能**：
- 任務清單查詢（進行中/過期/已完成）
- 任務類型管理
- 任務詳情展開
- 小組長進度報告

**使用者場景**：
- 學生：查看老師/家長指派的任務
- 小組長：查看小組成員任務進度

**任務類型歸屬**：
- 類型 1,3,4,5,6,9,13,14,15：由系統處理
- 類型 2,7,8,12,17,18,19：外包負責

---

### 2.2 任務報告模組 (MissionReport)

**功能定位**：任務測驗報告查看

**主要功能**：
- **學生端**：查看自己的測驗報告（依學年度分頁）
- **教師端**：查看班級學生任務完成情況、成績趨勢

**關鍵邏輯**：
- 任務類型 7/8 無分數，顯示「查看」
- 5 個 UNION 合併多種任務類型的測驗記錄

---

### 2.3 學力測驗模組 (EduExam)

**功能定位**：學力測驗/大考專區（學測、會考、指考等）

**考試類型對應**：

| 縮寫 | 類型 | 名稱 |
|------|------|------|
| BAT | 1/6 | 學力測驗 |
| CAP | 2/9 | 國中教育會考 |
| GSAT | 3/13 | 學測 |
| TVE | 4/14 | 統測 |
| AST | 5/15 | 指考 |

**主要功能**：
- 考試類型列表
- 試卷清單（依科目/年度）
- 作答流程（開始/儲存/交卷）
- 歷史紀錄查詢

---

### 2.4 知識結構模組 (Knowledge)

**功能定位**：課程知識節點與學習資源管理

**主要功能**：
- 節點基本資訊查詢
- 節點資源標記（影片/練習/DA 等）
- 上下位節點關聯
- 出版商/單元列表

**特殊邏輯**：
- 國語文注音符號特殊處理
- 高中數學 5 種分流（普高/技高ABC/綜高）

---

### 2.5 學習活動模組 (KsLearning)

**功能定位**：學習活動執行（練習題/動態評量/影片觀看）

**主要功能**：
| 端點 | 功能 |
|------|------|
| practice | 練習題取得 |
| practice-submit | 練習題提交（含代幣發放） |
| assessment | 動態評量取得 |
| assessment-submit | 動態評量提交 |
| video | 影片開始觀看 |
| video/record | 影片進度更新 |
| checkpoint | 檢核點取得 |
| checkpoint-submit | 檢核點提交 |

**代幣邏輯**：首次 100 分且歷史 < 3 次時發放額外代幣

---

### 2.6 素養題目模組 (Literacy)

**功能定位**：素養導向題目瀏覽與詳情

**主要功能**：
- 題目列表（單題/題組/互動）
- 題目詳情
- 篩選選項（版本/年級/主題）

**科目對應**：
- 國語(1,27) → map_sn(10,31)
- 數學(2,28) → map_sn(3,32)
- 自然(3,29) → map_sn(4,33)
- 運算思維(77) → map_sn(81)

---

### 2.7 個人學習記錄模組 (LearningRecord)

**功能定位**：學生個人學習報表

**主要功能**：
- 影片學習記錄（數量/時間/進度）
- 練習題記錄（數量/時間/答對率）
- 動態評量記錄
- AI 學習夥伴記錄
- 週/月歷史檢視（最近 7 期）

**權限邏輯**：
- 學生：查看自己記錄
- 家長：查看子女記錄（需驗證 user_family）

---

### 2.8 待辦事項模組 (Todo)

**功能定位**：SRL 行事曆待辦事項管理

**主要功能**：
- 事項列表（當日/當月）
- 新增/編輯/刪除事項
- 完成標記

---

### 2.9 個人設定模組 (PersonalConfig)

**功能定位**：使用者個人化設定

**設定項目**：
- 任務卡片/列表切換
- 行事曆顯示/隱藏

---

## 三、資料庫設計

### 3.1 核心資料表

#### 任務相關
| 資料表 | 用途 |
|--------|------|
| mission_info | 任務資訊（teacher_id, target_id, semester, mission_type） |
| mission_type | 任務類型定義 |
| mission_stud_record | 學生任務執行記錄（finish_node_count） |
| mission_group_leader | 小組長資訊 |

#### 測驗記錄
| 資料表 | 用途 |
|--------|------|
| exam_record_indicate | 縱貫診斷測驗記錄 |
| exam_record_indicator | 單元診斷測驗記錄 |
| eduexam_record | 學力測驗記錄 |
| exam_record_dynamic | 動態評量記錄 |
| exam_record_literacy_interactive | 素養互動測驗記錄 |

#### 學習資源
| 資料表 | 用途 |
|--------|------|
| video_concept_item | 教學影片 |
| video_review_record | 影片觀看記錄 |
| prac_answer | 練習題作答記錄 |
| map_node | 知識節點資源標記 |
| map_node_file | 補充教材檔案 |
| map_node_external | 外部連結 |

#### 課程結構
| 資料表 | 用途 |
|--------|------|
| publisher_mapping | 出版商對應節點 |
| indicateTest | 知識點關聯（上下位） |
| map_info | 科目→map_sn 對應 |
| concept_structure | 能力指標 |

#### 使用者相關
| 資料表 | 用途 |
|--------|------|
| user_info | 使用者資訊（access_level, grade） |
| user_status | 使用者狀態 |
| user_family | 家長-學生關聯 |
| user_person_config | 使用者設定 |

---

### 3.2 關鍵欄位說明

**mission_info 欄位**：
- `mission_type`：任務類型編號
- `target_type`：指派對象類型（I=個人, C=班級）
- `class_type`：班級類型（1=自組, 2=學扶, NULL=一般）
- `semester`：學期代碼（如 11501）
- `unable`：啟用狀態（1=啟用）

**access_level 對應**：
| 等級 | 身份 |
|------|------|
| 1,4,9 | 學生 |
| 11 | 家長 |
| 21,25 | 教師 |
| 22-24 | 校長 |
| 26-33 | 學校管理員 |

---

## 四、設計參考原則

### API 設計時應確認

1. **權限檢查**：確認使用者身分（學生/教師/家長）
2. **資料範圍**：確認只能存取自己/班級/子女的資料
3. **Hash 處理**：舊系統使用 `string2hash()`，新 API 使用 Token
4. **任務類型**：確認是否為外包負責類型
5. **Stateless**：避免 Session 依賴，所有參數透過 API 傳遞

### 常見參數

| 參數 | 說明 |
|------|------|
| semester | 學期代碼（YYYST，如 11501） |
| grade | 年級（1-12） |
| subject_id | 科目編號 |
| map_sn | 科目對應的地圖編號 |
| indicator | 知識點代碼 |
| mission_sn | 任務序號 |
