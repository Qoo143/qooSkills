---
name: mission-router-bug-fix
description: >
  Bug 修復分流。當需求單涉及錯誤修復、異常排查、功能故障時觸發。
  整合 systematic-debugging 方法論，確保找到根本原因才進行修復。
---

# Bug 修復分流

## 判斷條件

需求單符合以下特徵時，進入此分流：

- 使用者回報「錯誤」、「異常」、「失敗」
- 有錯誤代碼（如 `error:389`）
- 功能「原本可以用，現在不行」
- 「應該是 X 但結果是 Y」
- 附帶錯誤截圖或影片

---

## 鐵律

```
沒有根本原因調查，就不能嘗試修復
```

**在嘗試任何修復之前，必須先完成階段 1-3。**

---

## 處理步驟

### 階段 0：問題收集

確認需求單包含以下資訊，不足則向使用者詢問：

| 必要資訊 | 說明 |
|:---------|:-----|
| 重現步驟 | 完整操作流程 |
| 預期行為 | 使用者期望發生什麼 |
| 實際行為 | 實際發生了什麼 |
| 錯誤訊息 | 完整錯誤代碼或截圖 |
| 環境資訊 | 帳號類型、權限、瀏覽器 |

### 階段 1：根本原因調查

**在嘗試任何修復之前：**

1. **解析錯誤代碼**
   - 錯誤代碼格式通常是 `error:行號`
   - 使用 grep_search 定位程式碼行號
   - 完整閱讀錯誤堆疊

2. **讀取相關 Skills**
   - `database` - 了解資料結構
   - `backend` - 了解路由機制

3. **追蹤數據流**
   - 壞值從哪裡來？
   - 什麼調用了這個並傳入壞值？
   - 繼續向上追蹤直到找到源頭

### 階段 2：模式分析

1. **找到工作的示例** - 在同一代碼庫中找類似的正常運作代碼
2. **與參考進行比較** - 完整閱讀參考實現
3. **識別差異** - 列出正常與異常之間的每一個差異

### 階段 3：假設與測試

1. **形成單一假設**
   - 明確陳述：「我認為 X 是根本原因，因為 Y」

2. **最小測試**
   - 做最小的可能變更來測試假設

3. **驗證後繼續**
   - 有效？→ 進入階段 4
   - 無效？→ 形成新假設

### 階段 4：實施修復

**只有在完成階段 1-3 後才能進入：**

1. 起草 `implementation_plan.md`
2. 請使用者確認修復方案
3. 一次一個變更
4. 驗證修復

---

## 輸出格式

Bug 分析完成後，建立 `walkthrough.md` 包含：

```markdown
# [Bug 標題] 分析報告

## 問題描述
- 錯誤代碼：
- 重現步驟：
- 影響範圍：

## 根本原因
[明確說明根本原因]

## 相關檔案
| 檔案 | 用途 |
|:-----|:-----|
| [file](path) | 說明 |

## 流程圖
(mermaid flowchart)

## 建議修復方案
1. ...
2. ...
```

---

## 危險信號

如果發現自己在想：

| 想法 | 應對 |
|------|------|
| 「先快速修復，之後再調查」 | **停止，回到階段 1** |
| 「試試改變這個看看有沒有效」 | **停止，回到階段 1** |
| 「好像是這個問題，讓我修一下」 | **停止，回到階段 1** |
| 「一次修復嘗試應該沒問題」(已試過 2+) | **停止，質疑架構** |

---

## 相關 Skills

| Skill | 用途 |
|:------|:-----|
| `systematic-debugging` | 完整調試方法論 |
| `database` | 資料表結構參考 |
| `backend` | 後端開發規範 |
